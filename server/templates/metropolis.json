{
  "id": "da10b77dd665",
  "name": "sky-metropolis",
  "description": "Isometric city builder with AI-generated goals and resource management",
  "stack": "react-only",
  "complexity": "STANDARD",
  "files": [
    {
      "path": ".env.local",
      "content": "GEMINI_API_KEY=PLACEHOLDER_API_KEY\n",
      "role": "COMPONENT",
      "language": "text",
      "size": 35,
      "order": 0
    },
    {
      "path": ".gitignore",
      "content": "# Logs\nlogs\n*.log\nnpm-debug.log*\nyarn-debug.log*\nyarn-error.log*\npnpm-debug.log*\nlerna-debug.log*\n\nnode_modules\ndist\ndist-ssr\n*.local\n\n# Editor directories and files\n.vscode/*\n!.vscode/extensions.json\n.idea\n.DS_Store\n*.suo\n*.ntvs*\n*.njsproj\n*.sln\n*.sw?\n",
      "role": "COMPONENT",
      "language": "text",
      "size": 253,
      "order": 1
    },
    {
      "path": "App.tsx",
      "content": "/**\n * @license\n * SPDX-License-Identifier: Apache-2.0\n*/\nimport React, { useState, useEffect, useCallback, useRef } from 'react';\nimport { Grid, TileData, BuildingType, CityStats, AIGoal, NewsItem } from './types';\nimport { GRID_SIZE, BUILDINGS, TICK_RATE_MS, INITIAL_MONEY } from './constants';\nimport IsoMap from './components/IsoMap';\nimport UIOverlay from './components/UIOverlay';\nimport StartScreen from './components/StartScreen';\nimport { generateCityGoal, generateNewsEvent } from './services/geminiService';\n\n// Initialize empty grid with island shape generation for 3D visual interest\nconst createInitialGrid = (): Grid => {\n  const grid: Grid = [];\n  const center = GRID_SIZE / 2;\n  // const radius = GRID_SIZE / 2 - 1;\n\n  for (let y = 0; y < GRID_SIZE; y++) {\n    const row: TileData[] = [];\n    for (let x = 0; x < GRID_SIZE; x++) {\n      // Simple circle crop for island look\n      const dist = Math.sqrt((x-center)*(x-center) + (y-center)*(y-center));\n      \n      row.push({ x, y, buildingType: BuildingType.None });\n    }\n    grid.push(row);\n  }\n  return grid;\n};\n\nfunction App() {\n  // --- Game State ---\n  const [gameStarted, setGameStarted] = useState(false);\n  const [aiEnabled, setAiEnabled] = useState(true);\n\n  const [grid, setGrid] = useState<Grid>(createInitialGrid);\n  const [stats, setStats] = useState<CityStats>({ money: INITIAL_MONEY, population: 0, day: 1 });\n  const [selectedTool, setSelectedTool] = useState<BuildingType>(BuildingType.Road);\n  \n  // --- AI State ---\n  const [currentGoal, setCurrentGoal] = useState<AIGoal | null>(null);\n  const [isGeneratingGoal, setIsGeneratingGoal] = useState(false);\n  const [newsFeed, setNewsFeed] = useState<NewsItem[]>([]);\n  \n  // Refs for accessing state inside intervals without dependencies\n  const gridRef = useRef(grid);\n  const statsRef = useRef(stats);\n  const goalRef = useRef(currentGoal);\n  const aiEnabledRef = useRef(aiEnabled);\n\n  // Sync refs\n  useEffect(() => { gridRef.current = grid; }, [grid]);\n  useEffect(() => { statsRef.current = stats; }, [stats]);\n  useEffect(() => { goalRef.current = currentGoal; }, [currentGoal]);\n  useEffect(() => { aiEnabledRef.current = aiEnabled; }, [aiEnabled]);\n\n  // --- AI Logic Wrappers ---\n\n  const addNewsItem = useCallback((item: NewsItem) => {\n    setNewsFeed(prev => [...prev.slice(-12), item]); // Keep last few\n  }, []);\n\n  const fetchNewGoal = useCallback(async () => {\n    if (isGeneratingGoal || !aiEnabledRef.current) return;\n    setIsGeneratingGoal(true);\n    // Short delay for visual effect\n    await new Promise(r => setTimeout(r, 500));\n    \n    const newGoal = await generateCityGoal(statsRef.current, gridRef.current);\n    if (newGoal) {\n      setCurrentGoal(newGoal);\n    } else {\n      // Retry soon if failed, but only if AI still enabled\n      if(aiEnabledRef.current) setTimeout(fetchNewGoal, 5000);\n    }\n    setIsGeneratingGoal(false);\n  }, [isGeneratingGoal]); \n\n  const fetchNews = useCallback(async () => {\n    // chance to fetch news per tick\n    if (!aiEnabledRef.current || Math.random() > 0.15) return; \n    const news = await generateNewsEvent(statsRef.current, null);\n    if (news) addNewsItem(news);\n  }, [addNewsItem]);\n\n\n  // --- Initial Setup ---\n  useEffect(() => {\n    if (!gameStarted) return;\n\n    addNewsItem({ id: Date.now().toString(), text: \"Welcome to SkyMetropolis. Terrain generation complete.\", type: 'positive' });\n    \n    if (aiEnabled) {\n      // @google/genai-api-key-fix: The API key's availability is a hard requirement and should not be checked in the UI.\n      fetchNewGoal();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [gameStarted]);\n\n\n  // --- Game Loop ---\n  useEffect(() => {\n    if (!gameStarted) return;\n\n    const intervalId = setInterval(() => {\n      // 1. Calculate income/pop gen\n      let dailyIncome = 0;\n      let dailyPopGrowth = 0;\n      let buildingCounts: Record<string, number> = {};\n\n      gridRef.current.flat().forEach(tile => {\n        if (tile.buildingType !== BuildingType.None) {\n          const config = BUILDINGS[tile.buildingType];\n          dailyIncome += config.incomeGen;\n          dailyPopGrowth += config.popGen;\n          buildingCounts[tile.buildingType] = (buildingCounts[tile.buildingType] || 0) + 1;\n        }\n      });\n\n      // Cap population growth by residential count just for some logic\n      const resCount = buildingCounts[BuildingType.Residential] || 0;\n      const maxPop = resCount * 50; // 50 people per house max\n\n      // 2. Update Stats\n      setStats(prev => {\n        let newPop = prev.population + dailyPopGrowth;\n        if (newPop > maxPop) newPop = maxPop; // limit\n        if (resCount === 0 && prev.population > 0) newPop = Math.max(0, prev.population - 5); // people leave if no homes\n\n        const newStats = {\n          money: prev.money + dailyIncome,\n          population: newPop,\n          day: prev.day + 1,\n        };\n        \n        // 3. Check Goal Completion\n        const goal = goalRef.current;\n        if (aiEnabledRef.current && goal && !goal.completed) {\n          let isMet = false;\n          if (goal.targetType === 'money' && newStats.money >= goal.targetValue) isMet = true;\n          if (goal.targetType === 'population' && newStats.population >= goal.targetValue) isMet = true;\n          if (goal.targetType === 'building_count' && goal.buildingType) {\n            if ((buildingCounts[goal.buildingType] || 0) >= goal.targetValue) isMet = true;\n          }\n\n          if (isMet) {\n            setCurrentGoal({ ...goal, completed: true });\n          }\n        }\n\n        return newStats;\n      });\n\n      // 4. Trigger news\n      fetchNews();\n\n    }, TICK_RATE_MS);\n\n    return () => clearInterval(intervalId);\n  }, [fetchNews, gameStarted]);\n\n\n  // --- Interaction Logic ---\n\n  const handleTileClick = useCallback((x: number, y: number) => {\n    if (!gameStarted) return; // Prevent clicking through start screen\n\n    const currentGrid = gridRef.current;\n    const currentStats = statsRef.current;\n    const tool = selectedTool; // Capture current tool\n    \n    if (x < 0 || x >= GRID_SIZE || y < 0 || y >= GRID_SIZE) return;\n\n    const currentTile = currentGrid[y][x];\n    const buildingConfig = BUILDINGS[tool];\n\n    // Bulldoze logic\n    if (tool === BuildingType.None) {\n      if (currentTile.buildingType !== BuildingType.None) {\n        const demolishCost = 5;\n        if (currentStats.money >= demolishCost) {\n            const newGrid = currentGrid.map(row => [...row]);\n            newGrid[y][x] = { ...currentTile, buildingType: BuildingType.None };\n            setGrid(newGrid);\n            setStats(prev => ({ ...prev, money: prev.money - demolishCost }));\n            // Sound effect here\n        } else {\n            addNewsItem({id: Date.now().toString(), text: \"Cannot afford demolition costs.\", type: 'negative'});\n        }\n      }\n      return;\n    }\n\n    // Placement Logic\n    if (currentTile.buildingType === BuildingType.None) {\n      if (currentStats.money >= buildingConfig.cost) {\n        // Deduct cost\n        setStats(prev => ({ ...prev, money: prev.money - buildingConfig.cost }));\n        \n        // Place building\n        const newGrid = currentGrid.map(row => [...row]);\n        newGrid[y][x] = { ...currentTile, buildingType: tool };\n        setGrid(newGrid);\n        // Sound effect here\n      } else {\n        // Not enough money feedback\n        addNewsItem({id: Date.now().toString() + Math.random(), text: `Treasury insufficient for ${buildingConfig.name}.`, type: 'negative'});\n      }\n    }\n  }, [selectedTool, addNewsItem, gameStarted]);\n\n  const handleClaimReward = () => {\n    if (currentGoal && currentGoal.completed) {\n      setStats(prev => ({ ...prev, money: prev.money + currentGoal.reward }));\n      addNewsItem({id: Date.now().toString(), text: `Goal achieved! ${currentGoal.reward} deposited to treasury.`, type: 'positive'});\n      setCurrentGoal(null);\n      fetchNewGoal();\n    }\n  };\n\n  const handleStart = (enabled: boolean) => {\n    setAiEnabled(enabled);\n    setGameStarted(true);\n  };\n\n  return (\n    <div className=\"relative w-screen h-screen overflow-hidden selection:bg-transparent selection:text-transparent bg-sky-900\">\n      {/* 3D Rendering Layer - Always visible now, providing background for start screen */}\n      <IsoMap \n        grid={grid} \n        onTileClick={handleTileClick} \n        hoveredTool={selectedTool}\n        population={stats.population}\n      />\n      \n      {/* Start Screen Overlay */}\n      {!gameStarted && (\n        <StartScreen onStart={handleStart} />\n      )}\n\n      {/* UI Layer */}\n      {gameStarted && (\n        <UIOverlay\n          stats={stats}\n          selectedTool={selectedTool}\n          onSelectTool={setSelectedTool}\n          currentGoal={currentGoal}\n          newsFeed={newsFeed}\n          onClaimReward={handleClaimReward}\n          isGeneratingGoal={isGeneratingGoal}\n          aiEnabled={aiEnabled}\n        />\n      )}\n\n      {/* CSS for animations and utility */}\n      <style>{`\n        @keyframes fade-in { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }\n        .animate-fade-in { animation: fade-in 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }\n        \n        .mask-image-b { -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%); mask-image: linear-gradient(to bottom, transparent 0%, black 15%); }\n        \n        /* Vertical text for toolbar label */\n        .writing-mode-vertical { writing-mode: vertical-rl; text-orientation: mixed; }\n        \n        /* Custom scrollbar for news */\n        ::-webkit-scrollbar { width: 4px; }\n        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }\n        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }\n        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }\n      `}</style>\n    </div>\n  );\n}\n\nexport default App;",
      "role": "COMPONENT",
      "language": "typescript",
      "size": 9931,
      "order": 2
    },
    {
      "path": "README.md",
      "content": "<div align=\"center\">\n<img width=\"1200\" height=\"475\" alt=\"GHBanner\" src=\"https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6\" />\n</div>\n\n# Run and deploy your AI Studio app\n\nThis contains everything you need to run your app locally.\n\nView your app in AI Studio: https://ai.studio/apps/bundled/sky_metropolis\n\n## Run Locally\n\n**Prerequisites:**  Node.js\n\n\n1. Install dependencies:\n   `npm install`\n2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key\n3. Run the app:\n   `npm run dev`\n",
      "role": "COMPONENT",
      "language": "markdown",
      "size": 536,
      "order": 3
    },
    {
      "path": "constants.tsx",
      "content": "/**\n * @license\n * SPDX-License-Identifier: Apache-2.0\n*/\nimport { BuildingConfig, BuildingType } from './types';\n\n// Map Settings\nexport const GRID_SIZE = 15;\n\n// Game Settings\nexport const TICK_RATE_MS = 2000; // Game loop updates every 2 seconds\nexport const INITIAL_MONEY = 1000;\n\nexport const BUILDINGS: Record<BuildingType, BuildingConfig> = {\n  [BuildingType.None]: {\n    type: BuildingType.None,\n    cost: 0,\n    name: 'Bulldoze',\n    description: 'Clear a tile',\n    color: '#ef4444', // Used for UI\n    popGen: 0,\n    incomeGen: 0,\n  },\n  [BuildingType.Road]: {\n    type: BuildingType.Road,\n    cost: 10,\n    name: 'Road',\n    description: 'Connects buildings.',\n    color: '#374151', // gray-700\n    popGen: 0,\n    incomeGen: 0,\n  },\n  [BuildingType.Residential]: {\n    type: BuildingType.Residential,\n    cost: 100,\n    name: 'House',\n    description: '+5 Pop/day',\n    color: '#f87171', // red-400\n    popGen: 5,\n    incomeGen: 0,\n  },\n  [BuildingType.Commercial]: {\n    type: BuildingType.Commercial,\n    cost: 200,\n    name: 'Shop',\n    description: '+$15/day',\n    color: '#60a5fa', // blue-400\n    popGen: 0,\n    incomeGen: 15,\n  },\n  [BuildingType.Industrial]: {\n    type: BuildingType.Industrial,\n    cost: 400,\n    name: 'Factory',\n    description: '+$40/day',\n    color: '#facc15', // yellow-400\n    popGen: 0,\n    incomeGen: 40,\n  },\n  [BuildingType.Park]: {\n    type: BuildingType.Park,\n    cost: 50,\n    name: 'Park',\n    description: 'Looks nice.',\n    color: '#4ade80', // green-400\n    popGen: 1,\n    incomeGen: 0,\n  },\n};",
      "role": "COMPONENT",
      "language": "typescript",
      "size": 1549,
      "order": 4
    },
    {
      "path": "index.css",
      "content": "",
      "role": "STYLE",
      "language": "css",
      "size": 0,
      "order": 5
    },
    {
      "path": "index.html",
      "content": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>PolyCity AI 3D</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <style>\n        /* Hide scrollbar for main view to act like a game canvas */\n        body { overflow: hidden; background-color: #0c4a6e; /* sky-900 */ }\n    </style>\n<script type=\"importmap\">\n{\n  \"imports\": {\n    \"react/\": \"https://esm.sh/react@^19.2.0/\",\n    \"react\": \"https://esm.sh/react@^19.2.0\",\n    \"react-dom/\": \"https://esm.sh/react-dom@^19.2.0/\",\n    \"react-dom\": \"https://esm.sh/react-dom@^19.2.0\",\n    \"@google/genai\": \"https://esm.sh/@google/genai@^1.25.0\",\n    \"three\": \"https://esm.sh/three@^0.173.0\",\n    \"@react-three/fiber\": \"https://esm.sh/@react-three/fiber@^9.0.0\",\n    \"@react-three/drei\": \"https://esm.sh/@react-three/drei@^10.0.0\"\n  }\n}\n</script>\n<link rel=\"stylesheet\" href=\"/index.css\">\n</head>\n<body>\n    <div id=\"root\"></div>\n    <script type=\"module\" src=\"/index.tsx\"></script>\n</body>\n</html>",
      "role": "COMPONENT",
      "language": "html",
      "size": 1057,
      "order": 6
    },
    {
      "path": "index.tsx",
      "content": "/**\n * @license\n * SPDX-License-Identifier: Apache-2.0\n*/\nimport React from 'react';\nimport ReactDOM from 'react-dom/client';\nimport App from './App';\n\nconst rootElement = document.getElementById('root');\nif (!rootElement) {\n  throw new Error(\"Could not find root element to mount to\");\n}\n\nconst root = ReactDOM.createRoot(rootElement);\nroot.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>\n);",
      "role": "ENTRY",
      "language": "typescript",
      "size": 407,
      "order": 7
    },
    {
      "path": "metadata.json",
      "content": "{\n  \"name\": \"Sky Metropolis\",\n  \"description\": \"Manage a virtual metropolis and fulfill tasks provided by Gemini.\",\n  \"requestFramePermissions\": []\n}",
      "role": "COMPONENT",
      "language": "json",
      "size": 149,
      "order": 8
    },
    {
      "path": "package.json",
      "content": "{\n  \"name\": \"sky-metropolis\",\n  \"private\": true,\n  \"version\": \"0.0.0\",\n  \"type\": \"module\",\n  \"scripts\": {\n    \"dev\": \"vite\",\n    \"build\": \"vite build\",\n    \"preview\": \"vite preview\"\n  },\n  \"dependencies\": {\n    \"react\": \"^19.2.0\",\n    \"react-dom\": \"^19.2.0\",\n    \"@google/genai\": \"^1.25.0\",\n    \"three\": \"^0.173.0\",\n    \"@react-three/fiber\": \"^9.0.0\",\n    \"@react-three/drei\": \"^10.0.0\"\n  },\n  \"devDependencies\": {\n    \"@types/node\": \"^22.14.0\",\n    \"@vitejs/plugin-react\": \"^5.0.0\",\n    \"typescript\": \"~5.8.2\",\n    \"vite\": \"^6.2.0\"\n  }\n}\n",
      "role": "CONFIG",
      "language": "json",
      "size": 539,
      "order": 9
    },
    {
      "path": "tsconfig.json",
      "content": "{\n  \"compilerOptions\": {\n    \"target\": \"ES2022\",\n    \"experimentalDecorators\": true,\n    \"useDefineForClassFields\": false,\n    \"module\": \"ESNext\",\n    \"lib\": [\n      \"ES2022\",\n      \"DOM\",\n      \"DOM.Iterable\"\n    ],\n    \"skipLibCheck\": true,\n    \"types\": [\n      \"node\"\n    ],\n    \"moduleResolution\": \"bundler\",\n    \"isolatedModules\": true,\n    \"moduleDetection\": \"force\",\n    \"allowJs\": true,\n    \"jsx\": \"react-jsx\",\n    \"paths\": {\n      \"@/*\": [\n        \"./*\"\n      ]\n    },\n    \"allowImportingTsExtensions\": true,\n    \"noEmit\": true\n  }\n}",
      "role": "CONFIG",
      "language": "json",
      "size": 542,
      "order": 10
    },
    {
      "path": "types.ts",
      "content": "/**\n * @license\n * SPDX-License-Identifier: Apache-2.0\n*/\nexport enum BuildingType {\n  None = 'None',\n  Road = 'Road',\n  Residential = 'Residential',\n  Commercial = 'Commercial',\n  Industrial = 'Industrial',\n  Park = 'Park',\n}\n\nexport interface BuildingConfig {\n  type: BuildingType;\n  cost: number;\n  name: string;\n  description: string;\n  color: string; // Main color for 3D material\n  popGen: number; // Population generation per tick\n  incomeGen: number; // Money generation per tick\n}\n\nexport interface TileData {\n  x: number;\n  y: number;\n  buildingType: BuildingType;\n  // Suggested by AI for visual variety later\n  variant?: number;\n}\n\nexport type Grid = TileData[][];\n\nexport interface CityStats {\n  money: number;\n  population: number;\n  day: number;\n}\n\nexport interface AIGoal {\n  description: string;\n  targetType: 'population' | 'money' | 'building_count';\n  targetValue: number;\n  buildingType?: BuildingType; // If target is building_count\n  reward: number;\n  completed: boolean;\n}\n\nexport interface NewsItem {\n  id: string;\n  text: string;\n  type: 'positive' | 'negative' | 'neutral';\n}",
      "role": "TYPE",
      "language": "typescript",
      "size": 1102,
      "order": 11
    },
    {
      "path": "vite.config.ts",
      "content": "import path from 'path';\nimport { defineConfig, loadEnv } from 'vite';\nimport react from '@vitejs/plugin-react';\n\nexport default defineConfig(({ mode }) => {\n    const env = loadEnv(mode, '.', '');\n    return {\n      server: {\n        port: 3000,\n        host: '0.0.0.0',\n      },\n      plugins: [react()],\n      define: {\n        'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),\n        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)\n      },\n      resolve: {\n        alias: {\n          '@': path.resolve(__dirname, '.'),\n        }\n      }\n    };\n});\n",
      "role": "CONFIG",
      "language": "typescript",
      "size": 580,
      "order": 12
    },
    {
      "path": "services/geminiService.ts",
      "content": "/**\n * @license\n * SPDX-License-Identifier: Apache-2.0\n*/\nimport { GoogleGenAI, Type } from \"@google/genai\";\nimport { AIGoal, BuildingType, CityStats, Grid, NewsItem } from \"../types\";\nimport { BUILDINGS } from \"../constants\";\n\nconst ai = new GoogleGenAI({ apiKey: process.env.API_KEY });\n\nconst modelId = 'gemini-2.5-flash';\n\n// --- Goal Generation ---\n\n// @google/genai-schema-fix: The `Schema` type is not exported from @google/genai. Use a const object for the schema.\nconst goalSchema = {\n  type: Type.OBJECT,\n  properties: {\n    description: {\n      type: Type.STRING,\n      description: \"A short, creative description of the goal from the perspective of city council or citizens.\",\n    },\n    targetType: {\n      type: Type.STRING,\n      enum: ['population', 'money', 'building_count'],\n      description: \"The metric to track.\",\n    },\n    targetValue: {\n      type: Type.INTEGER,\n      description: \"The target numeric value to reach.\",\n    },\n    buildingType: {\n      type: Type.STRING,\n      enum: [BuildingType.Residential, BuildingType.Commercial, BuildingType.Industrial, BuildingType.Park, BuildingType.Road],\n      description: \"Required if targetType is building_count.\",\n    },\n    reward: {\n      type: Type.INTEGER,\n      description: \"Monetary reward for completion.\",\n    },\n  },\n  required: ['description', 'targetType', 'targetValue', 'reward'],\n};\n\nexport const generateCityGoal = async (stats: CityStats, grid: Grid): Promise<AIGoal | null> => {\n  // @google/genai-api-key-fix: The API key must be obtained exclusively from the environment variable `process.env.API_KEY`. Do not add checks for its existence.\n\n  // Count buildings\n  const counts: Record<string, number> = {};\n  grid.flat().forEach(tile => {\n    counts[tile.buildingType] = (counts[tile.buildingType] || 0) + 1;\n  });\n\n  const context = `\n    Current City Stats:\n    Day: ${stats.day}\n    Money: $${stats.money}\n    Population: ${stats.population}\n    Buildings: ${JSON.stringify(counts)}\n    Building Costs/Stats: ${JSON.stringify(\n      Object.values(BUILDINGS).filter(b => b.type !== BuildingType.None).map(b => ({type: b.type, cost: b.cost, pop: b.popGen, income: b.incomeGen}))\n    )}\n  `;\n\n  const prompt = `You are the AI City Advisor for a simulation game. Based on the current city stats, generate a challenging but achievable short-term goal for the player to help the city grow. Return JSON.`;\n\n  try {\n    const response = await ai.models.generateContent({\n      model: modelId,\n      // @google/genai-generate-content-fix: For text-only prompts, `contents` should be a single string.\n      contents: `${context}\\n${prompt}`,\n      config: {\n        responseMimeType: \"application/json\",\n        responseSchema: goalSchema,\n        temperature: 0.7,\n      },\n    });\n\n    // @google/genai-response-text-fix: Access the `text` property directly from the response.\n    if (response.text) {\n      const goalData = JSON.parse(response.text) as Omit<AIGoal, 'completed'>;\n      return { ...goalData, completed: false };\n    }\n  } catch (error) {\n    console.error(\"Error generating goal:\", error);\n  }\n  return null;\n};\n\n// --- News Feed Generation ---\n\n// @google/genai-schema-fix: The `Schema` type is not exported from @google/genai. Use a const object for the schema.\nconst newsSchema = {\n  type: Type.OBJECT,\n  properties: {\n    text: { type: Type.STRING, description: \"A one-sentence news headline representing life in the city.\" },\n    type: { type: Type.STRING, enum: ['positive', 'negative', 'neutral'] },\n  },\n  required: ['text', 'type'],\n};\n\nexport const generateNewsEvent = async (stats: CityStats, recentAction: string | null): Promise<NewsItem | null> => {\n  // @google/genai-api-key-fix: The API key must be obtained exclusively from the environment variable `process.env.API_KEY`. Do not add checks for its existence.\n\n  const context = `City Stats - Pop: ${stats.population}, Money: ${stats.money}, Day: ${stats.day}. ${recentAction ? `Recent Action: ${recentAction}` : ''}`;\n  const prompt = \"Generate a very short, isometric-sim-city style news headline based on the city state. Can be funny, cynical, or celebratory.\";\n\n  try {\n    const response = await ai.models.generateContent({\n      model: modelId,\n      // @google/genai-generate-content-fix: For text-only prompts, `contents` should be a single string.\n      contents: `${context}\\n${prompt}`,\n      config: {\n        responseMimeType: \"application/json\",\n        responseSchema: newsSchema,\n        temperature: 1.1, // High temp for variety\n      },\n    });\n\n    // @google/genai-response-text-fix: Access the `text` property directly from the response.\n    if (response.text) {\n      const data = JSON.parse(response.text);\n      return {\n        id: Date.now().toString() + Math.random(),\n        text: data.text,\n        type: data.type,\n      };\n    }\n  } catch (error) {\n    console.error(\"Error generating news:\", error);\n  }\n  return null;\n};",
      "role": "SERVICE",
      "language": "typescript",
      "size": 4930,
      "order": 13
    },
    {
      "path": "components/IsoMap.tsx",
      "content": "/**\n * @license\n * SPDX-License-Identifier: Apache-2.0\n*/\nimport React, { useState, useMemo, useRef, useEffect, useCallback } from 'react';\nimport { Canvas, useFrame, useThree, ThreeElements } from '@react-three/fiber';\nimport { MapControls, Environment, SoftShadows, Instance, Instances, Float, useTexture, Outlines, OrthographicCamera } from '@react-three/drei';\nimport * as THREE from 'three';\nimport { MathUtils } from 'three';\nimport { Grid, BuildingType, TileData } from '../types';\nimport { GRID_SIZE, BUILDINGS } from '../constants';\n\n// Fix for TypeScript not recognizing R3F elements in JSX\ndeclare global {\n  namespace JSX {\n    interface IntrinsicElements extends ThreeElements {}\n  }\n}\n\n// --- Constants & Helpers ---\nconst WORLD_OFFSET = GRID_SIZE / 2 - 0.5;\nconst gridToWorld = (x: number, y: number) => [x - WORLD_OFFSET, 0, y - WORLD_OFFSET] as [number, number, number];\n\n// Deterministic random based on coordinates\nconst getHash = (x: number, y: number) => Math.abs(Math.sin(x * 12.9898 + y * 78.233) * 43758.5453) % 1;\nconst getRandomRange = (min: number, max: number) => Math.random() * (max - min) + min;\n\n// Shared Geometries\nconst boxGeo = new THREE.BoxGeometry(1, 1, 1);\nconst cylinderGeo = new THREE.CylinderGeometry(1, 1, 1, 8);\nconst coneGeo = new THREE.ConeGeometry(1, 1, 4);\nconst sphereGeo = new THREE.SphereGeometry(1, 8, 8);\n\n// --- 1. Advanced Procedural Buildings ---\n\n// FIX: Wrap component in React.memo to ensure TypeScript recognizes it as a component that accepts a 'key' prop.\nconst WindowBlock = React.memo(({ position, scale }: { position: [number, number, number], scale: [number, number, number] }) => (\n  <mesh geometry={boxGeo} position={position} scale={scale}>\n    <meshStandardMaterial color=\"#bfdbfe\" emissive=\"#bfdbfe\" emissiveIntensity={0.2} roughness={0.1} metalness={0.8} />\n  </mesh>\n));\n\nconst SmokeStack = ({ position }: { position: [number, number, number] }) => {\n  const ref = useRef<THREE.Group>(null);\n  useFrame((state) => {\n    if (ref.current) {\n      ref.current.children.forEach((child, i) => {\n        const cloud = child as THREE.Mesh;\n        cloud.position.y += 0.01 + i * 0.005;\n        cloud.scale.addScalar(0.005);\n        \n        const material = cloud.material as THREE.MeshStandardMaterial;\n        if (material) {\n          material.opacity -= 0.005;\n          if (cloud.position.y > 1.5) {\n            cloud.position.y = 0;\n            cloud.scale.setScalar(0.1 + Math.random() * 0.1);\n            material.opacity = 0.6;\n          }\n        }\n      });\n    }\n  });\n\n  return (\n    <group position={position}>\n      <mesh geometry={cylinderGeo} castShadow receiveShadow position={[0, 0.5, 0]} scale={[0.2, 1, 0.2]}>\n        <meshStandardMaterial color=\"#4b5563\" />\n      </mesh>\n      <group ref={ref} position={[0, 1, 0]}>\n        {[0, 1, 2].map(i => (\n          <mesh key={i} geometry={sphereGeo} position={[Math.random()*0.1, i*0.4, Math.random()*0.1]} scale={0.2}>\n            <meshStandardMaterial color=\"#d1d5db\" transparent opacity={0.6} flatShading />\n          </mesh>\n        ))}\n      </group>\n    </group>\n  );\n};\n\ninterface BuildingMeshProps {\n  type: BuildingType;\n  baseColor: string;\n  x: number;\n  y: number;\n  opacity?: number;\n  transparent?: boolean;\n}\n\nconst ProceduralBuilding = React.memo(({ type, baseColor, x, y, opacity = 1, transparent = false }: BuildingMeshProps) => {\n  const hash = getHash(x, y);\n  const variant = Math.floor(hash * 100); // 0-99\n  const rotation = Math.floor(hash * 4) * (Math.PI / 2);\n  \n  // Color variation\n  const color = useMemo(() => {\n    const c = new THREE.Color(baseColor);\n    // Shift hue and lightness slightly based on hash\n    c.offsetHSL(hash * 0.1 - 0.05, 0, hash * 0.2 - 0.1);\n    return c;\n  }, [baseColor, hash]);\n\n  const mainMat = useMemo(() => new THREE.MeshStandardMaterial({ color, flatShading: true, opacity, transparent, roughness: 0.8 }), [color, opacity, transparent]);\n  const accentMat = useMemo(() => new THREE.MeshStandardMaterial({ color: new THREE.Color(color).multiplyScalar(0.7), flatShading: true, opacity, transparent }), [color, opacity, transparent]);\n  const roofMat = useMemo(() => new THREE.MeshStandardMaterial({ color: new THREE.Color(color).multiplyScalar(0.5).offsetHSL(0,0,-0.1), flatShading: true, opacity, transparent }), [color, opacity, transparent]);\n\n  const commonProps = { castShadow: true, receiveShadow: true };\n\n  // Buildings are built assuming y=0 is ground level within their group\n  // Adjust vertical position to sit on top of ground tile (approx -0.3)\n  const yOffset = -0.3;\n\n  return (\n    <group rotation={[0, rotation, 0]} position={[0, yOffset, 0]}>\n      {(() => {\n        switch (type) {\n          case BuildingType.Residential:\n            if (variant < 33) {\n              // Cozy Cottage\n              return (\n                <>\n                  <mesh {...commonProps} material={mainMat} geometry={boxGeo} position={[0, 0.3, 0]} scale={[0.7, 0.6, 0.6]} />\n                  <mesh {...commonProps} material={roofMat} geometry={coneGeo} position={[0, 0.75, 0]} scale={[0.6, 0.4, 0.6]} rotation={[0, Math.PI/4, 0]} />\n                  <WindowBlock position={[0.2, 0.3, 0.31]} scale={[0.15, 0.2, 0.05]} />\n                  <WindowBlock position={[-0.2, 0.3, 0.31]} scale={[0.15, 0.2, 0.05]} />\n                  <mesh {...commonProps} material={accentMat} geometry={boxGeo} position={[0, 0.1, 0.32]} scale={[0.15, 0.2, 0.05]} />\n                </>\n              );\n            } else if (variant < 66) {\n              // Modern Boxy\n              return (\n                <>\n                  <mesh {...commonProps} material={mainMat} geometry={boxGeo} position={[-0.1, 0.35, 0]} scale={[0.6, 0.7, 0.8]} />\n                  <mesh {...commonProps} material={accentMat} geometry={boxGeo} position={[0.25, 0.25, 0.1]} scale={[0.4, 0.5, 0.6]} />\n                  <WindowBlock position={[-0.1, 0.5, 0.41]} scale={[0.4, 0.2, 0.05]} />\n                </>\n              );\n            } else {\n              // Townhouse\n              return (\n                <>\n                  <mesh {...commonProps} material={mainMat} geometry={boxGeo} position={[0, 0.5, 0]} scale={[0.5, 1, 0.6]} />\n                  <mesh {...commonProps} material={roofMat} geometry={boxGeo} position={[0, 1.05, 0]} scale={[0.55, 0.1, 0.65]} />\n                  <WindowBlock position={[0, 0.7, 0.31]} scale={[0.3, 0.2, 0.05]} />\n                  <WindowBlock position={[0, 0.3, 0.31]} scale={[0.3, 0.2, 0.05]} />\n                </>\n              );\n            }\n\n          case BuildingType.Commercial:\n            if (variant < 40) {\n              // High-rise\n              const height = 1.5 + hash * 1.5;\n              return (\n                <>\n                  <mesh {...commonProps} material={mainMat} geometry={boxGeo} position={[0, height/2, 0]} scale={[0.7, height, 0.7]} />\n                  {Array.from({ length: Math.floor(height * 3) }).map((_, i) => (\n                    <WindowBlock key={i} position={[0, 0.2 + i * 0.3, 0]} scale={[0.72, 0.15, 0.72]} />\n                  ))}\n                  <mesh {...commonProps} material={accentMat} geometry={boxGeo} position={[0, height + 0.1, 0]} scale={[0.5, 0.2, 0.5]} />\n                </>\n              );\n            } else if (variant < 70) {\n              // Shop\n              return (\n                <>\n                  <mesh {...commonProps} material={mainMat} geometry={boxGeo} position={[0, 0.4, 0]} scale={[0.9, 0.8, 0.8]} />\n                  <WindowBlock position={[0, 0.3, 0.41]} scale={[0.8, 0.4, 0.05]} />\n                  <mesh {...commonProps} material={new THREE.MeshStandardMaterial({ color: hash > 0.5 ? '#ef4444' : '#3b82f6' })} geometry={boxGeo} position={[0, 0.55, 0.5]} scale={[0.9, 0.1, 0.2]} rotation={[Math.PI/6, 0, 0]} />\n                </>\n              );\n            } else {\n              // Corner store\n               return (\n                <>\n                  <mesh {...commonProps} material={mainMat} geometry={boxGeo} position={[-0.2, 0.5, -0.2]} scale={[0.5, 1, 0.5]} />\n                  <mesh {...commonProps} material={accentMat} geometry={boxGeo} position={[0.1, 0.3, 0.1]} scale={[0.7, 0.6, 0.7]} />\n                  <WindowBlock position={[0.1, 0.3, 0.46]} scale={[0.6, 0.3, 0.05]} />\n                  <mesh {...commonProps} material={new THREE.MeshStandardMaterial({color: '#9ca3af'})} geometry={boxGeo} position={[0.2, 0.65, 0.2]} scale={[0.2, 0.1, 0.2]} />\n                </>\n               )\n            }\n\n          case BuildingType.Industrial:\n            if (variant < 50) {\n              // Factory\n              return (\n                <>\n                  <mesh {...commonProps} material={mainMat} geometry={boxGeo} position={[0, 0.4, 0]} scale={[0.9, 0.8, 0.8]} />\n                  <mesh {...commonProps} material={roofMat} geometry={boxGeo} position={[-0.2, 0.9, 0]} scale={[0.4, 0.2, 0.8]} rotation={[0,0,Math.PI/4]} />\n                  <mesh {...commonProps} material={roofMat} geometry={boxGeo} position={[0.2, 0.9, 0]} scale={[0.4, 0.2, 0.8]} rotation={[0,0,Math.PI/4]} />\n                  <SmokeStack position={[0.3, 0.4, 0.3]} />\n                </>\n              );\n            } else {\n              // Warehouse\n              return (\n                <>\n                  <mesh {...commonProps} material={mainMat} geometry={boxGeo} position={[-0.2, 0.3, 0]} scale={[0.5, 0.6, 0.9]} />\n                  <mesh {...commonProps} material={accentMat} geometry={cylinderGeo} position={[0.25, 0.4, -0.2]} scale={[0.2, 0.8, 0.2]} />\n                  <mesh {...commonProps} material={accentMat} geometry={cylinderGeo} position={[0.25, 0.4, 0.25]} scale={[0.2, 0.8, 0.2]} />\n                  <mesh {...commonProps} material={new THREE.MeshStandardMaterial({color: '#6b7280'})} geometry={boxGeo} position={[0.25, 0.7, 0]} scale={[0.05, 0.05, 0.5]} />\n                </>\n              );\n            }\n\n          case BuildingType.Park:\n            const treeCount = 1 + Math.floor(hash * 3);\n            const positions = [[-0.2, -0.2], [0.2, 0.2], [-0.2, 0.2], [0.2, -0.2]];\n            \n            return (\n              <group position={[0, -yOffset - 0.29, 0]}> {/* Adjust park base to sit exactly on top of ground tile */}\n                <mesh receiveShadow rotation={[-Math.PI / 2, 0, 0]} position={[0, 0.01, 0]}>\n                    <planeGeometry args={[0.9, 0.9]} />\n                    <meshStandardMaterial color=\"#86efac\" />\n                </mesh>\n                \n                {variant < 30 && (\n                    <group position={[0,0.05,0]}>\n                        <mesh material={new THREE.MeshStandardMaterial({color: '#cbd5e1'})} geometry={cylinderGeo} scale={[0.4, 0.1, 0.4]} castShadow receiveShadow />\n                        <mesh material={new THREE.MeshStandardMaterial({color: '#3b82f6', roughness: 0.1})} geometry={cylinderGeo} position={[0, 0.06, 0]} scale={[0.3, 0.05, 0.3]} />\n                    </group>\n                )}\n\n                {Array.from({length: treeCount}).map((_, i) => {\n                    const pos = positions[i % positions.length];\n                    const scale = 0.5 + getHash(x+i, y-i) * 0.5;\n                    const treeColor = new THREE.Color(\"#166534\").offsetHSL(0, 0, getHash(x,y+i)*0.2);\n                    return (\n                    <group key={i} position={[pos[0], 0, pos[1]]} scale={scale} rotation={[0, getHash(i,x)*Math.PI, 0]}>\n                        <mesh castShadow receiveShadow material={new THREE.MeshStandardMaterial({ color: '#78350f' })} geometry={cylinderGeo} position={[0, 0.15, 0]} scale={[0.1, 0.3, 0.1]} />\n                        <mesh castShadow receiveShadow material={new THREE.MeshStandardMaterial({ color: treeColor, flatShading: true })} geometry={coneGeo} position={[0, 0.4, 0]} scale={[0.4, 0.5, 0.4]} />\n                        <mesh castShadow receiveShadow material={new THREE.MeshStandardMaterial({ color: treeColor, flatShading: true })} geometry={coneGeo} position={[0, 0.65, 0]} scale={[0.3, 0.4, 0.3]} />\n                    </group>\n                    )\n                })}\n              </group>\n            );\n          case BuildingType.Road:\n             return null;\n          default:\n            return null;\n        }\n      })()}\n    </group>\n  );\n});\n\n// --- 2. Dynamic Systems (Traffic, Citizens, Environment) ---\n\nconst carColors = ['#ef4444', '#3b82f6', '#eab308', '#ffffff', '#1f2937', '#f97316'];\n\nconst TrafficSystem = ({ grid }: { grid: Grid }) => {\n  const roadTiles = useMemo(() => {\n    const roads: {x: number, y: number}[] = [];\n    grid.forEach(row => row.forEach(tile => {\n      if (tile.buildingType === BuildingType.Road) roads.push({x: tile.x, y: tile.y});\n    }));\n    return roads;\n  }, [grid]);\n\n  const carCount = Math.min(roadTiles.length, 30);\n  const carsRef = useRef<THREE.InstancedMesh>(null);\n  const carsState = useRef<Float32Array>(new Float32Array(0)); \n  const dummy = useMemo(() => new THREE.Object3D(), []);\n  const colors = useMemo(() => new Float32Array(0), []);\n\n  useEffect(() => {\n    if (roadTiles.length < 2) return;\n    carsState.current = new Float32Array(carCount * 6);\n    const newColors = new Float32Array(carCount * 3);\n\n    for (let i = 0; i < carCount; i++) {\n      const startNode = roadTiles[Math.floor(Math.random() * roadTiles.length)];\n      carsState.current[i*6 + 0] = startNode.x;\n      carsState.current[i*6 + 1] = startNode.y;\n      carsState.current[i*6 + 2] = startNode.x;\n      carsState.current[i*6 + 3] = startNode.y;\n      carsState.current[i*6 + 4] = 1; // force pick new target\n      carsState.current[i*6 + 5] = getRandomRange(0.01, 0.03); // speed\n\n      const color = new THREE.Color(carColors[Math.floor(Math.random() * carColors.length)]);\n      newColors[i*3] = color.r; newColors[i*3+1] = color.g; newColors[i*3+2] = color.b;\n    }\n\n    if (carsRef.current) {\n        carsRef.current.instanceColor = new THREE.InstancedBufferAttribute(newColors, 3);\n    }\n  }, [roadTiles, carCount]);\n\n  useFrame(() => {\n    if (!carsRef.current || roadTiles.length < 2 || carsState.current.length === 0) return;\n\n    for (let i = 0; i < carCount; i++) {\n      const idx = i * 6;\n      let curX = carsState.current[idx];\n      let curY = carsState.current[idx+1];\n      let tarX = carsState.current[idx+2];\n      let tarY = carsState.current[idx+3];\n      let progress = carsState.current[idx+4];\n      const speed = carsState.current[idx+5];\n\n      progress += speed;\n\n      if (progress >= 1) {\n        curX = tarX;\n        curY = tarY;\n        progress = 0;\n        \n        const neighbors = roadTiles.filter(t => \n          (Math.abs(t.x - curX) === 1 && t.y === curY) || \n          (Math.abs(t.y - curY) === 1 && t.x === curX)\n        );\n\n        if (neighbors.length > 0) {\n            // Simple pathfinding: avoid going back immediately\n            const valid = neighbors.length > 1 \n                ? neighbors.filter(n => Math.abs(n.x - carsState.current[idx]) > 0.1 || Math.abs(n.y - carsState.current[idx+1]) > 0.1)\n                : neighbors;\n            \n            const next = valid.length > 0 \n                ? valid[Math.floor(Math.random() * valid.length)]\n                : neighbors[0];\n            \n            tarX = next.x;\n            tarY = next.y;\n        } else {\n            const rnd = roadTiles[Math.floor(Math.random() * roadTiles.length)];\n            curX = rnd.x; curY = rnd.y; tarX = rnd.x; tarY = rnd.y;\n        }\n      }\n\n      carsState.current[idx] = curX;\n      carsState.current[idx+1] = curY;\n      carsState.current[idx+2] = tarX;\n      carsState.current[idx+3] = tarY;\n      carsState.current[idx+4] = progress;\n\n      // Interpolate position\n      const gx = MathUtils.lerp(curX, tarX, progress);\n      const gy = MathUtils.lerp(curY, tarY, progress);\n\n      // Determine driving side offset\n      const dx = tarX - curX;\n      const dy = tarY - curY;\n      const angle = Math.atan2(dy, dx);\n      \n      // Offset to right side relative to movement\n      const offsetAmt = 0.15;\n      // Normals: (-dy, dx)\n      const len = Math.sqrt(dx*dx + dy*dy) || 1;\n      const offX = (-dy/len) * offsetAmt;\n      const offY = (dx/len) * offsetAmt;\n\n      const [wx, _, wz] = gridToWorld(gx + offX, gy + offY);\n\n      // Road surface is approx -0.3. Car height 0.15.\n      dummy.position.set(wx, -0.3 + 0.075, wz);\n      dummy.rotation.set(0, -angle, 0);\n      // Car dimensions (Length(X), Height(Y), Width(Z) assuming 0 rotation aligns with X)\n      dummy.scale.set(0.5, 0.15, 0.3); \n      \n      dummy.updateMatrix();\n      carsRef.current.setMatrixAt(i, dummy.matrix);\n    }\n    carsRef.current.instanceMatrix.needsUpdate = true;\n  });\n\n  if (roadTiles.length < 2) return null;\n\n  return (\n    <instancedMesh ref={carsRef} args={[boxGeo, undefined, carCount]} castShadow>\n      <meshStandardMaterial roughness={0.5} metalness={0.3} />\n    </instancedMesh>\n  );\n};\n\nconst clothesColors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#ffffff'];\n\nconst PopulationSystem = ({ population, grid }: { population: number, grid: Grid }) => {\n    const agentCount = Math.min(Math.floor(population / 2), 300); \n    const meshRef = useRef<THREE.InstancedMesh>(null);\n    \n    // Find tiles where people can walk (Roads, Parks, empty ground)\n    const walkableTiles = useMemo(() => {\n        const tiles: {x: number, y: number}[] = [];\n        grid.forEach(row => row.forEach(tile => {\n          if (tile.buildingType === BuildingType.Road || tile.buildingType === BuildingType.Park || tile.buildingType === BuildingType.None) {\n            tiles.push({x: tile.x, y: tile.y});\n          }\n        }));\n        return tiles;\n    }, [grid]);\n    \n    const agentsState = useRef<Float32Array>(new Float32Array(0));\n    const dummy = useMemo(() => new THREE.Object3D(), []);\n    \n    useEffect(() => {\n        if (agentCount === 0 || walkableTiles.length === 0) return;\n        agentsState.current = new Float32Array(agentCount * 6);\n        const newColors = new Float32Array(agentCount * 3);\n\n        for(let i=0; i<agentCount; i++) {\n            const t = walkableTiles[Math.floor(Math.random() * walkableTiles.length)];\n            // Spawn with random offset in tile\n            const x = t.x + getRandomRange(-0.4, 0.4);\n            const y = t.y + getRandomRange(-0.4, 0.4);\n\n            agentsState.current[i*6+0] = x;\n            agentsState.current[i*6+1] = y;\n            \n            // Initial target\n            const tt = walkableTiles[Math.floor(Math.random() * walkableTiles.length)];\n            agentsState.current[i*6+2] = tt.x + getRandomRange(-0.4, 0.4);\n            agentsState.current[i*6+3] = tt.y + getRandomRange(-0.4, 0.4);\n            \n            agentsState.current[i*6+4] = getRandomRange(0.005, 0.015); // speed\n            agentsState.current[i*6+5] = Math.random() * Math.PI * 2; // anim\n\n            const c = new THREE.Color(clothesColors[Math.floor(Math.random() * clothesColors.length)]);\n            newColors[i*3] = c.r; newColors[i*3+1] = c.g; newColors[i*3+2] = c.b;\n        }\n\n        if (meshRef.current) {\n            meshRef.current.instanceColor = new THREE.InstancedBufferAttribute(newColors, 3);\n        }\n    }, [agentCount, walkableTiles]);\n\n    useFrame((state) => {\n        if (!meshRef.current || agentCount === 0 || agentsState.current.length === 0) return;\n        const time = state.clock.elapsedTime;\n\n        for(let i=0; i<agentCount; i++) {\n            const idx = i*6;\n            let x = agentsState.current[idx];\n            let y = agentsState.current[idx+1];\n            let tx = agentsState.current[idx+2];\n            let ty = agentsState.current[idx+3];\n            const speed = agentsState.current[idx+4];\n            const animOffset = agentsState.current[idx+5];\n\n            const dx = tx - x;\n            const dy = ty - y;\n            const dist = Math.sqrt(dx*dx + dy*dy);\n\n            if (dist < 0.1) {\n                // Pick new random target from walkable\n                if (walkableTiles.length > 0) {\n                    const tt = walkableTiles[Math.floor(Math.random() * walkableTiles.length)];\n                    tx = tt.x + getRandomRange(-0.4, 0.4);\n                    ty = tt.y + getRandomRange(-0.4, 0.4);\n                    agentsState.current[idx+2] = tx;\n                    agentsState.current[idx+3] = ty;\n                }\n            } else {\n                x += (dx/dist) * speed;\n                y += (dy/dist) * speed;\n                agentsState.current[idx] = x;\n                agentsState.current[idx+1] = y;\n            }\n\n            const [wx, _, wz] = gridToWorld(x, y);\n\n            // Walking bounce\n            const bounce = Math.abs(Math.sin(time * 10 + animOffset)) * 0.03;\n\n            // Person dimensions\n            const height = 0.2;\n            const width = 0.08;\n            // Ground level approx -0.3 to -0.4\n            const groundY = -0.35; \n\n            dummy.position.set(wx, groundY + height/2 + bounce, wz);\n            dummy.rotation.set(0, -Math.atan2(dy, dx), 0);\n            dummy.scale.set(width, height, width);\n            \n            dummy.updateMatrix();\n            meshRef.current.setMatrixAt(i, dummy.matrix);\n        }\n        meshRef.current.instanceMatrix.needsUpdate = true;\n    });\n\n    if (agentCount === 0) return null;\n\n    return (\n        <instancedMesh ref={meshRef} args={[boxGeo, undefined, agentCount]} castShadow>\n            <meshStandardMaterial roughness={0.8} />\n        </instancedMesh>\n    )\n};\n\n// Clouds & Birds\nconst Cloud = ({ position, scale, speed }: { position: [number, number, number], scale: number, speed: number }) => {\n    const group = useRef<THREE.Group>(null);\n    useFrame((state, delta) => {\n        if (group.current) {\n            group.current.position.x += speed * delta;\n            if (group.current.position.x > GRID_SIZE * 1.5) group.current.position.x = -GRID_SIZE * 1.5;\n        }\n    });\n\n    const bubbles = useMemo(() => Array.from({length: 5 + Math.random() * 5}).map(() => ({\n        pos: [getRandomRange(-1,1), getRandomRange(-0.5, 0.5), getRandomRange(-1,1)] as [number, number, number],\n        scale: getRandomRange(0.5, 1.2)\n    })), []);\n\n    return (\n        <group ref={group} position={position} scale={scale}>\n            {bubbles.map((b, i) => (\n                <mesh key={i} geometry={sphereGeo} position={b.pos} scale={b.scale} castShadow>\n                    <meshStandardMaterial color=\"white\" flatShading opacity={0.9} transparent />\n                </mesh>\n            ))}\n        </group>\n    )\n}\n\nconst Bird = ({ position, speed, offset }: { position: [number, number, number], speed: number, offset: number }) => {\n    const ref = useRef<THREE.Group>(null);\n    useFrame((state) => {\n        if(ref.current) {\n            const time = state.clock.elapsedTime + offset;\n            ref.current.position.x = position[0] + Math.sin(time * speed) * GRID_SIZE;\n            ref.current.position.z = position[1] + Math.cos(time * speed) * GRID_SIZE/2;\n            ref.current.rotation.y = -time * speed + Math.PI;\n            ref.current.scale.y = 1 + Math.sin(time * 15) * 0.3;\n        }\n    });\n\n    return (\n        <group ref={ref} position={[position[0], position[2], position[1]]}>\n            <mesh geometry={boxGeo} scale={[0.2, 0.05, 0.05]} position={[0.1,0,0]} rotation={[0, Math.PI/4, 0]}><meshBasicMaterial color=\"#333\" /></mesh>\n            <mesh geometry={boxGeo} scale={[0.2, 0.05, 0.05]} position={[-0.1,0,0]} rotation={[0, -Math.PI/4, 0]}><meshBasicMaterial color=\"#333\" /></mesh>\n        </group>\n    )\n}\n\nconst EnvironmentEffects = () => {\n    return (\n        <group raycast={() => null}>\n             {/* Clouds */}\n            <Cloud position={[-12, 8, 4]} scale={1.5} speed={0.3} />\n            <Cloud position={[5, 9, -8]} scale={1.2} speed={0.5} />\n            <Cloud position={[15, 7, 10]} scale={1.8} speed={0.2} />\n            \n            {/* Birds */}\n            <group position={[0, 0, 0]} scale={0.8}>\n                <Bird position={[0, 0, 10]} speed={0.6} offset={0} />\n                <Bird position={[0, 0, 10]} speed={0.6} offset={1.2} />\n                <Bird position={[0, 0, 10]} speed={0.6} offset={2.5} />\n            </group>\n\n            {/* Water */}\n            <mesh rotation={[-Math.PI / 2, 0, 0]} position={[0, -0.6, 0]} receiveShadow>\n                <planeGeometry args={[GRID_SIZE * 4, GRID_SIZE * 4]} />\n                <meshStandardMaterial color=\"#3b82f6\" roughness={0.1} metalness={0.5} opacity={0.8} transparent />\n            </mesh>\n        </group>\n    )\n};\n\n\n// --- 3. Main Map Component ---\n\nconst RoadMarkings = React.memo(({ x, y, grid, yOffset }: { x: number; y: number; grid: Grid; yOffset: number }) => {\n  const lineMaterial = useMemo(() => new THREE.MeshStandardMaterial({ color: '#fbbf24' }), []);\n  const lineGeo = useMemo(() => new THREE.PlaneGeometry(0.1, 0.5), []);\n\n  const hasUp = y > 0 && grid[y - 1][x].buildingType === BuildingType.Road;\n  const hasDown = y < GRID_SIZE - 1 && grid[y + 1][x].buildingType === BuildingType.Road;\n  const hasLeft = x > 0 && grid[y][x - 1].buildingType === BuildingType.Road;\n  const hasRight = x < GRID_SIZE - 1 && grid[y][x + 1].buildingType === BuildingType.Road;\n\n  const connections = [hasUp, hasDown, hasLeft, hasRight].filter(Boolean).length;\n  \n  // Isolated road piece: draw a default line\n  if (connections === 0) {\n    return (\n      <mesh rotation={[-Math.PI / 2, 0, 0]} position={[0, yOffset, 0]} geometry={lineGeo} material={lineMaterial} />\n    );\n  }\n\n  return (\n    <group rotation={[-Math.PI / 2, 0, 0]} position={[0, yOffset, 0]}>\n      {/* Center point for junctions to fill the gap, lifted slightly to avoid z-fighting */}\n      {(hasUp || hasDown) && (hasLeft || hasRight) && (\n        <mesh position={[0, 0, 0.005]} material={lineMaterial}>\n           <planeGeometry args={[0.12, 0.12]} />\n        </mesh>\n      )}\n\n      {hasUp && <mesh position={[0, 0.25, 0]} geometry={lineGeo} material={lineMaterial} />}\n      {hasDown && <mesh position={[0, -0.25, 0]} geometry={lineGeo} material={lineMaterial} />}\n      {hasLeft && <mesh position={[-0.25, 0, 0]} rotation={[0, 0, Math.PI / 2]} geometry={lineGeo} material={lineMaterial} />}\n      {hasRight && <mesh position={[0.25, 0, 0]} rotation={[0, 0, Math.PI / 2]} geometry={lineGeo} material={lineMaterial} />}\n    </group>\n  );\n});\n\ninterface GroundTileProps {\n    type: BuildingType;\n    x: number;\n    y: number;\n    grid: Grid;\n    onHover: (x: number, y: number) => void;\n    onLeave: () => void;\n    onClick: (x: number, y: number) => void;\n}\n\n// Ground Tile: Handles pointer events and forms base terrain\nconst GroundTile = React.memo(({ type, x, y, grid, onHover, onLeave, onClick }: GroundTileProps) => {\n  const [wx, _, wz] = gridToWorld(x, y);\n  \n  let color = '#10b981';\n  // Base level for tiles, slightly varying\n  let topY = -0.3; \n  let thickness = 0.5;\n  \n  if (type === BuildingType.None) {\n    const noise = getHash(x, y);\n    color = noise > 0.7 ? '#059669' : noise > 0.3 ? '#10b981' : '#34d399';\n    topY = -0.3 - noise * 0.1; // Slight height variation for grass\n  } else if (type === BuildingType.Road) {\n    color = '#374151';\n    topY = -0.29; // slightly higher\n  } else {\n    color = '#d1d5db'; // concrete base\n    topY = -0.28;\n  }\n\n  const centerY = topY - thickness/2;\n\n  return (\n    <mesh \n        position={[wx, centerY, wz]} \n        receiveShadow castShadow\n        onPointerEnter={(e) => { e.stopPropagation(); onHover(x, y); }}\n        onPointerOut={(e) => { e.stopPropagation(); onLeave(); }}\n        onPointerDown={(e) => {\n            e.stopPropagation();\n            if (e.button === 0) onClick(x, y);\n        }}\n    >\n      <boxGeometry args={[1, thickness, 1]} />\n      <meshStandardMaterial color={color} flatShading roughness={1} />\n      {type === BuildingType.Road && <RoadMarkings x={x} y={y} grid={grid} yOffset={thickness / 2 + 0.001} />}\n    </mesh>\n  );\n});\n\n// Selection/Hover Cursor\nconst Cursor = ({ x, y, color }: { x: number, y: number, color: string }) => {\n  const [wx, _, wz] = gridToWorld(x, y);\n  return (\n    <mesh position={[wx, -0.25, wz]} rotation={[-Math.PI / 2, 0, 0]} raycast={() => null}>\n      <planeGeometry args={[1, 1]} />\n      <meshBasicMaterial color={color} transparent opacity={0.4} side={THREE.DoubleSide} depthTest={false} />\n      <Outlines thickness={0.05} color=\"white\" />\n    </mesh>\n  );\n};\n\n\ninterface IsoMapProps {\n  grid: Grid;\n  onTileClick: (x: number, y: number) => void;\n  hoveredTool: BuildingType;\n  population: number;\n}\n\nconst IsoMap: React.FC<IsoMapProps> = ({ grid, onTileClick, hoveredTool, population }) => {\n  const [hoveredTile, setHoveredTile] = useState<{x: number, y: number} | null>(null);\n\n  const handleHover = useCallback((x: number, y: number) => {\n    setHoveredTile({ x, y });\n  }, []);\n\n  const handleLeave = useCallback(() => {\n    setHoveredTile(null);\n  }, []);\n\n  // Preview Logic\n  const showPreview = hoveredTile && grid[hoveredTile.y][hoveredTile.x].buildingType === BuildingType.None && hoveredTool !== BuildingType.None;\n  const previewColor = showPreview ? BUILDINGS[hoveredTool].color : 'white';\n  const isBulldoze = hoveredTool === BuildingType.None;\n  \n  const previewPos = hoveredTile ? gridToWorld(hoveredTile.x, hoveredTile.y) : [0,0,0];\n\n  return (\n    <div className=\"absolute inset-0 bg-sky-900 touch-none\">\n      <Canvas shadows dpr={[1, 1.5]} gl={{ antialias: true }}>\n        <OrthographicCamera makeDefault zoom={45} position={[20, 20, 20]} near={-100} far={200} />\n        \n        <MapControls \n          enableRotate={true}\n          enableZoom={true}\n          minZoom={20}\n          maxZoom={120}\n          maxPolarAngle={Math.PI / 2.2}\n          minPolarAngle={0.1}\n          target={[0,-0.5,0]}\n        />\n\n        <ambientLight intensity={0.5} color=\"#cceeff\" />\n        <directionalLight\n          castShadow\n          position={[15, 20, 10]}\n          intensity={2}\n          color=\"#fffbeb\"\n          shadow-mapSize={[2048, 2048]}\n          shadow-camera-left={-15} shadow-camera-right={15}\n          shadow-camera-top={15} shadow-camera-bottom={-15}\n        >\n        </directionalLight>\n        <Environment preset=\"city\" />\n\n        <EnvironmentEffects />\n\n        <group>\n          {grid.map((row, y) =>\n            row.map((tile, x) => {\n              // Calculate world position once per tile\n              const [wx, _, wz] = gridToWorld(x, y);\n              \n              return (\n              <React.Fragment key={`${x}-${y}`}>\n                <GroundTile \n                    type={tile.buildingType} \n                    x={x} y={y} \n                    grid={grid}\n                    onHover={handleHover}\n                    onLeave={handleLeave}\n                    onClick={onTileClick}\n                />\n                \n                {/* Building visual - apply world position to group to align with ground tile */}\n                <group position={[wx, 0, wz]} raycast={() => null}>\n                    {tile.buildingType !== BuildingType.None && tile.buildingType !== BuildingType.Road && (\n                      <ProceduralBuilding \n                        type={tile.buildingType} \n                        baseColor={BUILDINGS[tile.buildingType].color} \n                        x={x} y={y} \n                      />\n                    )}\n                </group>\n              </React.Fragment>\n            )})\n          )}\n\n          {/* Visual Elements - disable pointer events */}\n          <group raycast={() => null}>\n            <TrafficSystem grid={grid} />\n            <PopulationSystem population={population} grid={grid} />\n\n            {/* Placement Preview */}\n            {showPreview && hoveredTile && (\n              <group position={[previewPos[0], 0, previewPos[2]]}>\n                <Float speed={3} rotationIntensity={0} floatIntensity={0.1} floatingRange={[0, 0.1]}>\n                  <ProceduralBuilding \n                    type={hoveredTool} \n                    baseColor={previewColor} \n                    x={hoveredTile.x} \n                    y={hoveredTile.y} \n                    transparent \n                    opacity={0.7} \n                  />\n                </Float>\n              </group>\n            )}\n\n            {/* Highlight */}\n            {hoveredTile && (\n              <Cursor \n                x={hoveredTile.x} \n                y={hoveredTile.y} \n                color={isBulldoze ? '#ef4444' : (showPreview ? '#ffffff' : '#000000')} \n              />\n            )}\n          </group>\n        </group>\n        \n        <SoftShadows size={10} samples={8} />\n      </Canvas>\n    </div>\n  );\n};\n\nexport default IsoMap;",
      "role": "COMPONENT",
      "language": "typescript",
      "size": 32693,
      "order": 14
    },
    {
      "path": "components/StartScreen.tsx",
      "content": "/**\n * @license\n * SPDX-License-Identifier: Apache-2.0\n*/\nimport React, { useState } from 'react';\n\ninterface StartScreenProps {\n  onStart: (aiEnabled: boolean) => void;\n}\n\nconst StartScreen: React.FC<StartScreenProps> = ({ onStart }) => {\n  const [aiEnabled, setAiEnabled] = useState(true);\n\n  return (\n    <div className=\"absolute inset-0 flex flex-col items-center justify-center z-50 text-white font-sans p-6 bg-black/30 backdrop-blur-sm transition-all duration-1000\">\n      <div className=\"max-w-md w-full bg-slate-900/90 p-8 rounded-2xl border border-slate-700 shadow-2xl backdrop-blur-xl relative overflow-hidden animate-fade-in\">\n        {/* Decorative background glow */}\n        <div className=\"absolute -top-24 -right-24 w-48 h-48 bg-cyan-500/20 rounded-full blur-3xl pointer-events-none\"></div>\n        <div className=\"absolute -bottom-24 -left-24 w-48 h-48 bg-indigo-500/20 rounded-full blur-3xl pointer-events-none\"></div>\n        \n        <div className=\"relative z-10\">\n            <h1 className=\"text-5xl font-black mb-2 bg-gradient-to-br from-white via-cyan-200 to-blue-400 bg-clip-text text-transparent tracking-tight\">\n            SkyMetropolis\n            </h1>\n            <p className=\"text-slate-400 mb-8 text-sm font-medium uppercase tracking-widest\">\n            Isometric City Builder\n            </p>\n\n            <div className=\"bg-slate-800/50 p-5 rounded-xl border border-slate-700/50 mb-8 hover:border-slate-600 transition-colors shadow-inner\">\n            <label className=\"flex items-center justify-between cursor-pointer group\">\n                <div className=\"flex flex-col gap-1\">\n                <span className=\"font-bold text-base text-slate-200 group-hover:text-white transition-colors flex items-center gap-2\">\n                    AI City Advisor\n                    {aiEnabled && <span className=\"flex h-2 w-2 rounded-full bg-cyan-400 animate-pulse\"></span>}\n                </span>\n                <span className=\"text-xs text-slate-500 group-hover:text-slate-400 transition-colors\">\n                    Enable dynamic quests & news events via Gemini API\n                </span>\n                </div>\n                \n                <div className=\"relative flex-shrink-0 ml-4\">\n                <input \n                    type=\"checkbox\" \n                    className=\"sr-only peer\"\n                    checked={aiEnabled}\n                    onChange={(e) => setAiEnabled(e.target.checked)}\n                />\n                <div className=\"w-11 h-6 bg-slate-700 rounded-full peer peer-focus:ring-2 peer-focus:ring-cyan-500/40 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-300 after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600 peer-checked:after:bg-white\"></div>\n                </div>\n            </label>\n            </div>\n\n            <button \n            onClick={() => onStart(aiEnabled)}\n            className=\"w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-xl shadow-lg shadow-cyan-900/20 transform transition-all hover:scale-[1.02] active:scale-[0.98] text-lg tracking-wide\"\n            >\n            Start Building\n            </button>\n\n            <div className=\"mt-8 text-center\">\n                <a \n                    href=\"https://x.com/ammaar\" \n                    target=\"_blank\" \n                    rel=\"noreferrer\" \n                    className=\"inline-flex items-center gap-2 text-xs text-slate-500 hover:text-cyan-400 transition-colors font-mono group\"\n                >\n                    <span>Created by</span>\n                    <span className=\"font-bold group-hover:underline decoration-cyan-500/50 underline-offset-2\">@ammaar</span>\n                </a>\n            </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default StartScreen;",
      "role": "COMPONENT",
      "language": "typescript",
      "size": 3983,
      "order": 15
    },
    {
      "path": "components/UIOverlay.tsx",
      "content": "/**\n * @license\n * SPDX-License-Identifier: Apache-2.0\n*/\nimport React, { useEffect, useRef } from 'react';\nimport { BuildingType, CityStats, AIGoal, NewsItem } from '../types';\nimport { BUILDINGS } from '../constants';\n\ninterface UIOverlayProps {\n  stats: CityStats;\n  selectedTool: BuildingType;\n  onSelectTool: (type: BuildingType) => void;\n  currentGoal: AIGoal | null;\n  newsFeed: NewsItem[];\n  onClaimReward: () => void;\n  isGeneratingGoal: boolean;\n  aiEnabled: boolean;\n}\n\nconst tools = [\n  BuildingType.None, // Bulldoze\n  BuildingType.Road,\n  BuildingType.Residential,\n  BuildingType.Commercial,\n  BuildingType.Industrial,\n  BuildingType.Park,\n];\n\nconst ToolButton: React.FC<{\n  type: BuildingType;\n  isSelected: boolean;\n  onClick: () => void;\n  money: number;\n}> = ({ type, isSelected, onClick, money }) => {\n  const config = BUILDINGS[type];\n  const canAfford = money >= config.cost;\n  const isBulldoze = type === BuildingType.None;\n  \n  // Use 3D color for preview\n  const bgColor = isBulldoze ? config.color : config.color;\n\n  return (\n    <button\n      onClick={onClick}\n      disabled={!isBulldoze && !canAfford}\n      className={`\n        relative flex flex-col items-center justify-center rounded-lg border-2 transition-all shadow-lg backdrop-blur-sm flex-shrink-0\n        w-14 h-14 md:w-16 md:h-16\n        ${isSelected ? 'border-white bg-white/20 scale-110 z-10' : 'border-gray-600 bg-gray-900/80 hover:bg-gray-800'}\n        ${!isBulldoze && !canAfford ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}\n      `}\n      title={config.description}\n    >\n      <div className=\"w-6 h-6 md:w-8 md:h-8 rounded mb-0.5 md:mb-1 border border-black/30 shadow-inner flex items-center justify-center overflow-hidden\" style={{ backgroundColor: isBulldoze ? 'transparent' : bgColor }}>\n        {isBulldoze && <div className=\"w-full h-full bg-red-600 text-white flex justify-center items-center font-bold text-base md:text-lg\">\u2715</div>}\n        {type === BuildingType.Road && <div className=\"w-full h-2 bg-gray-800 transform -rotate-45\"></div>}\n      </div>\n      <span className=\"text-[8px] md:text-[10px] font-bold text-white uppercase tracking-wider drop-shadow-md leading-none\">{config.name}</span>\n      {config.cost > 0 && (\n        <span className={`text-[8px] md:text-[10px] font-mono leading-none ${canAfford ? 'text-green-300' : 'text-red-400'}`}>${config.cost}</span>\n      )}\n    </button>\n  );\n};\n\nconst UIOverlay: React.FC<UIOverlayProps> = ({\n  stats,\n  selectedTool,\n  onSelectTool,\n  currentGoal,\n  newsFeed,\n  onClaimReward,\n  isGeneratingGoal,\n  aiEnabled\n}) => {\n  const newsRef = useRef<HTMLDivElement>(null);\n\n  // Auto-scroll news\n  useEffect(() => {\n    if (newsRef.current) {\n      newsRef.current.scrollTop = newsRef.current.scrollHeight;\n    }\n  }, [newsFeed]);\n\n  return (\n    <div className=\"absolute inset-0 pointer-events-none flex flex-col justify-between p-2 md:p-4 font-sans z-10\">\n      \n      {/* Top Bar: Stats & Goal */}\n      <div className=\"flex flex-col md:flex-row md:justify-between md:items-start pointer-events-auto gap-2 w-full max-w-full\">\n        \n        {/* Stats */}\n        <div className=\"bg-gray-900/90 text-white p-2 md:p-3 rounded-xl border border-gray-700 shadow-2xl backdrop-blur-md flex gap-3 md:gap-6 items-center justify-between md:justify-start w-full md:w-auto\">\n          <div className=\"flex flex-col\">\n            <span className=\"text-[8px] md:text-[10px] text-gray-400 uppercase font-bold tracking-widest\">Treasury</span>\n            <span className=\"text-lg md:text-2xl font-black text-green-400 font-mono drop-shadow-md\">${stats.money.toLocaleString()}</span>\n          </div>\n          <div className=\"w-px h-6 md:h-8 bg-gray-700\"></div>\n          <div className=\"flex flex-col\">\n            <span className=\"text-[8px] md:text-[10px] text-gray-400 uppercase font-bold tracking-widest\">Citizens</span>\n            <span className=\"text-base md:text-xl font-bold text-blue-300 font-mono drop-shadow-md\">{stats.population.toLocaleString()}</span>\n          </div>\n          <div className=\"w-px h-6 md:h-8 bg-gray-700\"></div>\n          <div className=\"flex flex-col items-end\">\n             <span className=\"text-[8px] md:text-[10px] text-gray-400 uppercase font-bold tracking-widest\">Day</span>\n             <span className=\"text-base md:text-lg font-bold text-white font-mono\">{stats.day}</span>\n          </div>\n        </div>\n\n        {/* AI Goal Panel */}\n        <div className={`w-full md:w-80 bg-indigo-900/90 text-white rounded-xl border-2 border-indigo-500/50 shadow-[0_0_20px_rgba(99,102,241,0.4)] backdrop-blur-md overflow-hidden transition-all ${!aiEnabled ? 'opacity-80 grayscale-[0.5]' : ''}`}>\n          <div className=\"bg-indigo-800/80 px-3 md:px-4 py-1.5 md:py-2 flex justify-between items-center border-b border-indigo-600\">\n            <span className=\"font-bold uppercase text-[10px] md:text-xs tracking-widest flex items-center gap-2 shadow-sm\">\n              {aiEnabled ? (\n                <>\n                  <span className={`w-2 h-2 rounded-full ${isGeneratingGoal ? 'bg-yellow-400 animate-ping' : 'bg-cyan-400 animate-pulse'}`}></span>\n                  AI Advisor\n                </>\n              ) : (\n                <>\n                  <span className=\"w-2 h-2 rounded-full bg-green-400\"></span>\n                  Sandbox\n                </>\n              )}\n            </span>\n            {isGeneratingGoal && aiEnabled && <span className=\"text-[10px] animate-pulse text-yellow-300 font-mono\">Thinking...</span>}\n          </div>\n          \n          <div className=\"p-3 md:p-4\">\n            {aiEnabled ? (\n              currentGoal ? (\n                <>\n                  <p className=\"text-xs md:text-sm font-medium text-indigo-100 mb-2 md:mb-3 leading-tight drop-shadow\">\"{currentGoal.description}\"</p>\n                  \n                  <div className=\"flex justify-between items-center mt-1 md:mt-2 bg-indigo-950/60 p-1.5 md:p-2 rounded-lg border border-indigo-700/50\">\n                    <div className=\"text-[10px] md:text-xs text-gray-300\">\n                      Goal: <span className=\"font-mono font-bold text-white\">\n                        {currentGoal.targetType === 'building_count' ? BUILDINGS[currentGoal.buildingType!].name : \n                         currentGoal.targetType === 'money' ? '$' : 'Pop.'} {currentGoal.targetValue}\n                      </span>\n                    </div>\n                    <div className=\"text-[10px] md:text-xs text-yellow-300 font-bold font-mono bg-yellow-900/50 px-2 py-0.5 rounded border border-yellow-600/50\">\n                      +${currentGoal.reward}\n                    </div>\n                  </div>\n  \n                  {currentGoal.completed && (\n                    <button\n                      onClick={onClaimReward}\n                      className=\"mt-2 md:mt-3 w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-1.5 md:py-2 px-4 rounded shadow-[0_0_15px_rgba(34,197,94,0.6)] transition-all animate-bounce text-xs md:text-sm uppercase tracking-wide border border-green-400/50\"\n                    >\n                      Collect Reward\n                    </button>\n                  )}\n                </>\n              ) : (\n                <div className=\"text-xs md:text-sm text-gray-400 py-2 italic flex items-center gap-2\">\n                  <svg className=\"animate-spin h-3 w-3 md:h-4 md:w-4 text-indigo-400\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                  </svg>\n                  Analyzing city data...\n                </div>\n              )\n            ) : (\n              <div className=\"text-xs md:text-sm text-indigo-200/70 py-1\">\n                 <p className=\"mb-1\">Free play active.</p>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Bottom Bar: Tools & News */}\n      <div className=\"flex flex-col-reverse md:flex-row md:justify-between md:items-end pointer-events-auto mt-auto gap-2 w-full max-w-full\">\n        \n        {/* Toolbar - Reversed on Mobile so it appears below News (in DOM order is News -> Toolbar with col-reverse, but visually we want Toolbar bottom, News Top on mobile. \n            Actually, visually we want:\n            Mobile: \n            [News Feed]\n            [Toolbar]\n            \n            Desktop:\n            [Toolbar] ... [News Feed]\n            \n            If container is flex-col-reverse:\n            1. Child (Toolbar) -> Bottom\n            2. Child (News) -> Top\n            \n            If container is md:flex-row:\n            1. Child (Toolbar) -> Left\n            2. Child (News) -> Right\n            \n            This works perfectly.\n        */}\n        \n        <div className=\"flex gap-1 md:gap-2 bg-gray-900/80 p-1 md:p-2 rounded-2xl border border-gray-600/50 backdrop-blur-xl shadow-2xl w-full md:w-auto overflow-x-auto no-scrollbar justify-start md:justify-start\">\n          <div className=\"flex gap-1 md:gap-2 min-w-max px-1\">\n            {tools.map((type) => (\n              <ToolButton\n                key={type}\n                type={type}\n                isSelected={selectedTool === type}\n                onClick={() => onSelectTool(type)}\n                money={stats.money}\n              />\n            ))}\n          </div>\n          <div className=\"text-[8px] text-gray-500 uppercase writing-mode-vertical flex items-center justify-center font-bold tracking-widest border-l border-gray-700 pl-1 ml-1 select-none\">Build</div>\n        </div>\n\n        {/* News Feed */}\n        <div className=\"w-full md:w-80 h-32 md:h-48 bg-black/80 text-white rounded-xl border border-gray-700/80 backdrop-blur-xl shadow-2xl flex flex-col overflow-hidden relative\">\n          <div className=\"bg-gray-800/90 px-3 py-1.5 text-[10px] font-bold uppercase tracking-widest text-gray-300 border-b border-gray-600 flex justify-between items-center\">\n            <span>City Feed</span>\n            <span className={`w-1.5 h-1.5 rounded-full ${aiEnabled ? 'bg-red-500 animate-pulse' : 'bg-gray-500'}`}></span>\n          </div>\n          \n          {/* Scanline effect */}\n          <div className=\"absolute inset-0 pointer-events-none bg-[linear-gradient(to_bottom,rgba(255,255,255,0)_50%,rgba(0,0,0,0.1)_50%)] bg-[length:100%_4px] opacity-30 z-20\"></div>\n          \n          <div ref={newsRef} className=\"flex-1 overflow-y-auto p-2 md:p-3 space-y-2 text-[10px] md:text-xs font-mono scroll-smooth mask-image-b z-10\">\n            {newsFeed.length === 0 && <div className=\"text-gray-500 italic text-center mt-10\">No active news stream.</div>}\n            {newsFeed.map((news) => (\n              <div key={news.id} className={`\n                border-l-2 pl-2 py-1 transition-all animate-fade-in leading-tight relative\n                ${news.type === 'positive' ? 'border-green-500 text-green-200 bg-green-900/20' : ''}\n                ${news.type === 'negative' ? 'border-red-500 text-red-200 bg-red-900/20' : ''}\n                ${news.type === 'neutral' ? 'border-blue-400 text-blue-100 bg-blue-900/20' : ''}\n              `}>\n                <span className=\"opacity-70 text-[8px] absolute top-0.5 right-1\">{new Date(Number(news.id.split('.')[0])).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>\n                {news.text}\n              </div>\n            ))}\n          </div>\n        </div>\n\n      </div>\n      \n      {/* Credits */}\n      <div className=\"absolute bottom-1 right-2 md:right-4 text-[8px] md:text-[9px] text-white/30 font-mono text-right pointer-events-auto hover:text-white/60 transition-colors\">\n        <a href=\"https://x.com/ammaar\" target=\"_blank\" rel=\"noreferrer\">Created by @ammaar</a>\n      </div>\n    </div>\n  );\n};\n\nexport default UIOverlay;",
      "role": "COMPONENT",
      "language": "typescript",
      "size": 12089,
      "order": 16
    }
  ],
  "frontend_deps": {
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "@google/genai": "^1.25.0",
    "three": "^0.173.0",
    "@react-three/fiber": "^9.0.0",
    "@react-three/drei": "^10.0.0"
  },
  "backend_deps": {},
  "created_at": "1772068059",
  "version": 1,
  "category": "game"
}